---
title: "dummy test"
author: "Masatoshi Katabuchi"
date: "`r format(Sys.time(), '%B %d, %Y')`"
fontsize: 11pt
# link-citations: yes
# csl: templates/ecology-letters.csl
# bibliography: templates/seedling.bib
format:
  html:
    theme: spacelab #readable #sandstone #spacelab #flatly
    toc: true
    toc-depth: 2
    toc-title: Contents
    self-contained: true
    smooth-scroll: true
    highlight-style: github
---

```{r global_options, include=FALSE}
library(knitr)
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  message = FALSE,
  cache = FALSE,
  fig.align = "center",
  fig.show = "hold"
)
```

```{r,include=FALSE}
library(tidyverse)
library(targets)
library(tarchetypes)
library(kableExtra)
library(here)
library(loo)
library(bayesplot)
source(here("R", "stan.R"))
```


# Dummy data


- There are strong pressure effects ($\beta$)

- Species effects ($\alpha$) are not that strong


```{r}
tar_load(dummy_data)
dummy_data$alpha
dummy_data$beta
dummy_data$gamma
dummy_data$sigma_alpha
dummy_data$sigma_beta
dummy_data$sigma_gamma
dummy_data$sigma

dummy <- dummy_data$data

#model.matrix(y ~ as.factor(pressure), dummy)

dummy |>
  mutate(species = as.factor(species)) |>
  mutate(pressure = as.factor(pressure)) |>
  ggplot(aes(y = y, x = pressure, col = pressure)) +
  geom_violin() +
  geom_point(position = position_dodge(width = 0.90)) +
  facet_wrap(~ species)
```

## Model without interactions

- The esimates of $\beta$ (pressure effects) are close to the true values but their CIs are too large.

- ANOVA itself works.

```{r}
tar_load(fit_dummy_draws_anova)
tar_load(fit_dummy_summary_anova)
tar_load(fit_dummy_noint_draws_anova_noint)
tar_load(fit_dummy_noint_summary_anova_noint)
```

```{r}
fit_dummy_noint_summary_anova_noint |>
  filter(str_detect(variable, "alpha|beta")) |>
  filter(!str_detect(variable, "raw"))
```

```{r}
mcmc_intervals(
  fit_dummy_noint_draws_anova_noint,
  pars = c("mu_hat"),
  prob = 0.9,
  prob_outer = 0.95,
  regex_pars = "alpha\\[[1-5]\\]|beta\\[[1-9]\\]|tau\\[[1-9]\\]")
```

```{r}
tmp <- fit_dummy_noint_draws_anova_noint |>
    janitor::clean_names()  |>
    dplyr::select(tau_1, tau_2,  sigma) |>
    mutate(var_ = tau_1^2 + tau_2^2 + sigma^2) |>
    mutate(var_tau_1 = tau_1^2 / var_) |>
    mutate(var_tau_2 = tau_2^2 / var_) |>
    mutate(var_sigma = sigma^2 / var_)
apply(tmp, 2, mean)
```

## Model with interactions

```{r}
fit_dummy_summary_anova |>
  filter(str_detect(variable, "alpha|beta")) |>
  filter(!str_detect(variable, "raw"))
```

```{r}
mcmc_intervals(
  fit_dummy_draws_anova,
  pars = c("mu_hat"),
  prob = 0.9,
  prob_outer = 0.95,
  regex_pars = "alpha\\[[1-5]\\]|beta\\[[1-9]\\]|tau\\[[1-9]\\]")
```


# Fig. 1 data

Model with no interactions (log) is the best model.
```{r}
tar_load(loo_)
loo_compare(loo_[[1]], loo_[[2]], loo_[[3]], loo_[[4]])
```

## Model with no interactions (log)

```{r}
tar_load(fit_anova_log_nointer_draws_anova_noint)
tar_load(fit_anova_log_nointer_summary_anova_noint)
```

```{r}
fit_anova_log_nointer_summary_anova_noint |>
  filter(str_detect(variable, "alpha|beta")) |>
  filter(!str_detect(variable, "raw"))
```

```{r}
mcmc_intervals(
  fit_anova_log_nointer_draws_anova_noint,
  pars = c("mu_hat", "sigma"),
  prob = 0.9,
  prob_outer = 0.95,
  regex_pars = "alpha\\[[1-5]\\]|beta\\[[1-9]\\]|tau\\[[1-9]\\]")
```

```{r}
tmp <- fit_anova_log_nointer_draws_anova_noint |>
    janitor::clean_names()  |>
    dplyr::select(tau_1, tau_2, sigma) |>
    mutate(var_ = tau_1^2 + tau_2^2 + sigma^2) |>
    mutate(var_tau_1 = tau_1^2 / var_) |>
    mutate(var_tau_2 = tau_2^2 / var_) |>
    mutate(var_sigma = sigma^2 / var_)

apply(tmp, 2, mean)
```


## Model with interactions (log)

```{r}
tar_load(fit_anova_log_inter_draws_anova)
tar_load(fit_anova_log_inter_summary_anova)
```

```{r}
fit_anova_log_inter_summary_anova |>
  filter(str_detect(variable, "alpha|beta")) |>
  filter(!str_detect(variable, "raw"))
```

```{r}
mcmc_intervals(
  fit_anova_log_inter_draws_anova,
  pars = c("mu_hat", "sigma"),
  prob = 0.9,
  prob_outer = 0.95,
  regex_pars = "alpha\\[[1-5]\\]|beta\\[[1-9]\\]|tau\\[[1-9]\\]")
```

```{r}
tmp <- fit_anova_log_inter_draws_anova |>
    janitor::clean_names()  |>
    dplyr::select(tau_1, tau_2, tau_3, sigma) |>
    mutate(var_ = tau_1^2 + tau_2^2 + tau_3^2+ sigma^2) |>
    mutate(var_tau_1 = tau_1^2 / var_) |>
    mutate(var_tau_2 = tau_2^2 / var_) |>
    mutate(var_tau_3 = tau_3^2 / var_) |>
    mutate(var_sigma = sigma^2 / var_)

apply(tmp, 2, mean)
```

## Model without interactions and with errors

```{r}
tar_load(fit_anova_noint_err_log_draws_anova_noint_err)
tar_load(fit_anova_noint_err_log_summary_anova_noint_err)
```

```{r}
fit_anova_noint_err_log_summary_anova_noint_err |>
  filter(str_detect(variable, "alpha|beta")) |>
  filter(!str_detect(variable, "raw"))
```

```{r}
mcmc_intervals(
  fit_anova_noint_err_log_draws_anova_noint_err,
  pars = c("mu_hat", "sigma"),
  prob = 0.9,
  prob_outer = 0.95,
  regex_pars = "alpha\\[[1-5]\\]|beta\\[[1-9]\\]|tau\\[[1-9]\\]")
```

```{r}
mcmc_intervals(
  fit_anova_noint_err_log_draws_anova_noint_err,
  # pars = c("mu_hat", "sigma"),
  prob = 0.9,
  prob_outer = 0.95,
  regex_pars = "alpha_[1-9]|beta_[1-9]")
```

```{r}
tmp <- fit_anova_noint_err_log_draws_anova_noint_err |>
    janitor::clean_names()  |>
    dplyr::select(tau_1, tau_2, sigma) |>
    mutate(var_ = tau_1^2 + tau_2^2 + sigma^2) |>
    mutate(var_tau_1 = tau_1^2 / var_) |>
    mutate(var_tau_2 = tau_2^2 / var_) |>
    mutate(var_sigma = sigma^2 / var_)

apply(tmp, 2, mean)
```

## Model with interactions and with errors

```{r}
tar_load(fit_anova_int_err_log_draws_anova_int_err)
tar_load(fit_anova_int_err_log_summary_anova_int_err)
```

```{r}
fit_anova_int_err_log_summary_anova_int_err |>
  filter(str_detect(variable, "alpha|beta")) |>
  filter(!str_detect(variable, "raw"))
```

```{r}
mcmc_intervals(
  fit_anova_int_err_log_draws_anova_int_err,
  pars = c("mu_hat", "sigma"),
  prob = 0.9,
  prob_outer = 0.95,
  regex_pars = "alpha\\[[1-5]\\]|beta\\[[1-9]\\]|tau\\[[1-9]\\]")
```


```{r}
tmp <- fit_anova_int_err_log_draws_anova_int_err |>
    janitor::clean_names()  |>
    dplyr::select(tau_1, tau_2, tau_3, sigma) |>
    mutate(var_ = tau_1^2 + tau_2^2 + tau_3^2 + sigma^2) |>
    mutate(var_tau_1 = tau_1^2 / var_) |>
    mutate(var_tau_2 = tau_2^2 / var_) |>
    mutate(var_tau_3 = tau_3^2 / var_) |>
    mutate(var_sigma = sigma^2 / var_)

apply(tmp, 2, mean)
```

```{r}
tar_load(anova_data_err)
anova_data_err
```

Note that this visualization matched the sample IDs of pressure and tension calibraions in an arbitray manner.


```{r}
d <- read_csv(here("data", "ks_pres_tens_trees.csv"))

d_tens <- d |>
  filter(pres_type == "tens") |>
  rename(tens_calib = "ks") |>
  dplyr::select(!pres_type) |>
  dplyr::select(!sample_id)

d_pres <- d |>
  filter(pres_type == "pres") |>
  rename(pres_calib = "ks") |>
  dplyr::select(!pres_type) |>
  dplyr::select(!sample_id)

d2 <- full_join(d_pres, d_tens) |>
  mutate(sp = as.factor(species)) |>
  mutate(pres = as.factor(pressure))

d2 |>
 # filter(species == "HH") |>
  mutate(ks_ratio = pres_calib / tens_calib) |>
  ggplot(aes(y = ks_ratio, x = pres, fill = pres)) +
  geom_violin() +
  geom_point(position = position_dodge(width = 0.90)) +
  facet_grid( ~ sp) +
  theme_bw()

d2 |>
 # filter(species == "HH") |>
  mutate(ks_diff = pres_calib - tens_calib) |>
  ggplot(aes(y = ks_diff, x = pres, fill = pres)) +
  geom_violin() +
  geom_point(position = position_dodge(width = 0.90)) +
  facet_grid( ~ sp) +
  theme_bw()
  # scale_y_log10()
```

