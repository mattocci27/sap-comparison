---
title: "report"
author: "Masatoshi Katabuchi"
date: "`r format(Sys.time(), '%B %d, %Y')`"
fontsize: 11pt
# link-citations: yes
# csl: templates/ecology-letters.csl
# bibliography: templates/seedling.bib
format:
  html:
    theme: spacelab #readable #sandstone #spacelab #flatly
    toc: true
    toc-depth: 2
    toc-title: Contents
    self-contained: true
    smooth-scroll: true
    highlight-style: github
  pdf:
    toc: true
    keep-tex: true
    pdf-engine: pdflatex
    highlight-style: github
    include-in-header:
      text: |
        \usepackage{xr}
        \usepackage[default]{sourcesanspro}
        \usepackage{sourcecodepro}
        \usepackage{fancyhdr}
        \usepackage{fvextra}
        \pagestyle{fancy}
        \fancypagestyle{plain}{\pagestyle{fancy}}
        \renewcommand{\headrulewidth}{0pt}
        \fancyhead[RE,RO]{Song \textit{et al}. --Ecology Letters-- Appendix SX}
        \DefineVerbatimEnvironment{Highlighting}{Verbatim}{breaklines,commandchars=\\\{\}}
  docx:
    toc: true
    number-sections: false
    highlight-style: github
    html-math-method: katex
---

```{r global_options, include=FALSE}
library(knitr)
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  message = FALSE,
  cache = FALSE,
  fig.align = "center",
  fig.show = "hold"
)
```

```{r,include=FALSE}
library(tidyverse)
library(tarchetypes)
library(here)
library(kableExtra)
source(here("R", "stan.R"))
```

```{r,include=FALSE}
d <- read_csv(here("data-raw", "ks_pres_tens_five_spp.csv"))
# hist(d$pres_calib)
```

Non-log scale compares if the difference between flow rate by pressure and flow rate under tension (flow rate by pressure - flow rate under tension) is different from zero, whereas log scale compares the ratio between the two (log[flow rate by pressure / flow rate under tension]) is different from log one (log(1) = 0).


Fig. 1A (non-long)

```{r}
targets::tar_read(sma_scatter_plot)
```

```{r, include=FALSE}
targets::tar_read(sma_scatter_ks_plot)
```

Fig. 1A (log)

```{r}
targets::tar_read(sma_scatter_log_plot)
```


```{r, include=FALSE}
targets::tar_read(sma_scatter_ks_log_plot)
```

Fig. 1B-F (non-log)

```{r, fig.width = 2, fig.height = 6}
targets::tar_read(ks_bar_plot)
```


Fig. 1B-F (log)

```{r, fig.width = 2, fig.height = 6}
targets::tar_read(ks_log_bar_plot)
```

```{r}
#knitr::knit_exit()
targets::tar_load(dummy_data)
dummy_data

targets::tar_load(fit0_draws_anova)
pred0_draws <- create_stan_tab(fit0_draws_anova)
pred0_draws
```

```{r, fig.width = 3.5, fig.height = 3.5}
targets::tar_load(anova_data)
targets::tar_load(anova_data_log)

# d <- read_csv(here("data-raw", "pres_tens_five_spp.csv"))

d2 <- d |>
  mutate(jk = paste(d$species, d$pressure, sep = "_")) |>
  mutate(jk_fct = as.factor(jk) |> as.numeric()) |>
  dplyr::select(jk, jk_fct) |>
  unique() |>
  arrange(jk_fct)

sp_lab <- as.factor(d$species) |> levels()
pres_lab <- as.factor(d$pressure) |> levels()
int_lab <- as.factor(d2$jk) |> levels()

para_name <- c(sp_lab, pres_lab, rep(int_lab, 3), "mu")
```

```{r}
targets::tar_load(fit1_summary_anova)
targets::tar_load(fit2_summary_anova)
#knitr::knit_exit()
```



```{r}
fit1_summary_anova
fit2_summary_anova
```

```{r}
targets::tar_load(fit1_draws_anova)
pred1_draws <- create_stan_tab(fit1_draws_anova)
pred1_draws[, 2:6] <- round(pred1_draws[, 2:6], digits = 3)
pred1_draws |>
  filter(!str_detect(para, "raw")) |>
  mutate(para_name) |>
  mutate(para_name = cell_spec(para_name, bold= ifelse(q2_5 * q97_5 > 0, TRUE, FALSE))) |>
  kbl(booktabs = TRUE, escape = FALSE, format = "html", longtable = TRUE) |>
  kable_styling()

targets::tar_load(fit2_draws_anova)
pred2_draws <- create_stan_tab(fit2_draws_anova)
pred2_draws[, 2:6] <- round(pred2_draws[, 2:6], digits = 3)
pred2_draws |>
  filter(!str_detect(para, "raw")) |>
  mutate(para_name) |>
  mutate(para_name = cell_spec(para_name, bold= ifelse(q2_5 * q97_5 > 0, TRUE, FALSE))) |>
  kbl(booktabs = TRUE, escape = FALSE, format = "html", longtable = TRUE) |>
  kable_styling()
```

```{r}
pred1_draws <- create_stan_tab(fit1_draws_anova)

```

```{r}
targets::tar_visnetwork()
```


```{r}
devtools::session_info()
```
