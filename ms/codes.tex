% Options for packages loaded elsewhere
\PassOptionsToPackage{unicode}{hyperref}
\PassOptionsToPackage{hyphens}{url}
\PassOptionsToPackage{dvipsnames,svgnames,x11names}{xcolor}
%
\documentclass[
  12pt,
  letterpaper,
  DIV=11,
  numbers=noendperiod]{scrartcl}

\usepackage{amsmath,amssymb}
\usepackage{iftex}
\ifPDFTeX
  \usepackage[T1]{fontenc}
  \usepackage[utf8]{inputenc}
  \usepackage{textcomp} % provide euro and other symbols
\else % if luatex or xetex
  \usepackage{unicode-math}
  \defaultfontfeatures{Scale=MatchLowercase}
  \defaultfontfeatures[\rmfamily]{Ligatures=TeX,Scale=1}
\fi
\usepackage{lmodern}
\ifPDFTeX\else  
    % xetex/luatex font selection
\fi
% Use upquote if available, for straight quotes in verbatim environments
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
\IfFileExists{microtype.sty}{% use microtype if available
  \usepackage[]{microtype}
  \UseMicrotypeSet[protrusion]{basicmath} % disable protrusion for tt fonts
}{}
\makeatletter
\@ifundefined{KOMAClassName}{% if non-KOMA class
  \IfFileExists{parskip.sty}{%
    \usepackage{parskip}
  }{% else
    \setlength{\parindent}{0pt}
    \setlength{\parskip}{6pt plus 2pt minus 1pt}}
}{% if KOMA class
  \KOMAoptions{parskip=half}}
\makeatother
\usepackage{xcolor}
\usepackage[margin=1in]{geometry}
\setlength{\emergencystretch}{3em} % prevent overfull lines
\setcounter{secnumdepth}{-\maxdimen} % remove section numbering
% Make \paragraph and \subparagraph free-standing
\ifx\paragraph\undefined\else
  \let\oldparagraph\paragraph
  \renewcommand{\paragraph}[1]{\oldparagraph{#1}\mbox{}}
\fi
\ifx\subparagraph\undefined\else
  \let\oldsubparagraph\subparagraph
  \renewcommand{\subparagraph}[1]{\oldsubparagraph{#1}\mbox{}}
\fi

\usepackage{color}
\usepackage{fancyvrb}
\newcommand{\VerbBar}{|}
\newcommand{\VERB}{\Verb[commandchars=\\\{\}]}
\DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}
% Add ',fontsize=\small' for more characters per line
\usepackage{framed}
\definecolor{shadecolor}{RGB}{241,243,245}
\newenvironment{Shaded}{\begin{snugshade}}{\end{snugshade}}
\newcommand{\AlertTok}[1]{\textcolor[rgb]{0.68,0.00,0.00}{#1}}
\newcommand{\AnnotationTok}[1]{\textcolor[rgb]{0.37,0.37,0.37}{#1}}
\newcommand{\AttributeTok}[1]{\textcolor[rgb]{0.40,0.45,0.13}{#1}}
\newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.68,0.00,0.00}{#1}}
\newcommand{\BuiltInTok}[1]{\textcolor[rgb]{0.00,0.23,0.31}{#1}}
\newcommand{\CharTok}[1]{\textcolor[rgb]{0.13,0.47,0.30}{#1}}
\newcommand{\CommentTok}[1]{\textcolor[rgb]{0.37,0.37,0.37}{#1}}
\newcommand{\CommentVarTok}[1]{\textcolor[rgb]{0.37,0.37,0.37}{\textit{#1}}}
\newcommand{\ConstantTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{#1}}
\newcommand{\ControlFlowTok}[1]{\textcolor[rgb]{0.00,0.23,0.31}{#1}}
\newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.68,0.00,0.00}{#1}}
\newcommand{\DecValTok}[1]{\textcolor[rgb]{0.68,0.00,0.00}{#1}}
\newcommand{\DocumentationTok}[1]{\textcolor[rgb]{0.37,0.37,0.37}{\textit{#1}}}
\newcommand{\ErrorTok}[1]{\textcolor[rgb]{0.68,0.00,0.00}{#1}}
\newcommand{\ExtensionTok}[1]{\textcolor[rgb]{0.00,0.23,0.31}{#1}}
\newcommand{\FloatTok}[1]{\textcolor[rgb]{0.68,0.00,0.00}{#1}}
\newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.28,0.35,0.67}{#1}}
\newcommand{\ImportTok}[1]{\textcolor[rgb]{0.00,0.46,0.62}{#1}}
\newcommand{\InformationTok}[1]{\textcolor[rgb]{0.37,0.37,0.37}{#1}}
\newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.00,0.23,0.31}{#1}}
\newcommand{\NormalTok}[1]{\textcolor[rgb]{0.00,0.23,0.31}{#1}}
\newcommand{\OperatorTok}[1]{\textcolor[rgb]{0.37,0.37,0.37}{#1}}
\newcommand{\OtherTok}[1]{\textcolor[rgb]{0.00,0.23,0.31}{#1}}
\newcommand{\PreprocessorTok}[1]{\textcolor[rgb]{0.68,0.00,0.00}{#1}}
\newcommand{\RegionMarkerTok}[1]{\textcolor[rgb]{0.00,0.23,0.31}{#1}}
\newcommand{\SpecialCharTok}[1]{\textcolor[rgb]{0.37,0.37,0.37}{#1}}
\newcommand{\SpecialStringTok}[1]{\textcolor[rgb]{0.13,0.47,0.30}{#1}}
\newcommand{\StringTok}[1]{\textcolor[rgb]{0.13,0.47,0.30}{#1}}
\newcommand{\VariableTok}[1]{\textcolor[rgb]{0.07,0.07,0.07}{#1}}
\newcommand{\VerbatimStringTok}[1]{\textcolor[rgb]{0.13,0.47,0.30}{#1}}
\newcommand{\WarningTok}[1]{\textcolor[rgb]{0.37,0.37,0.37}{\textit{#1}}}

\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}\usepackage{longtable,booktabs,array}
\usepackage{calc} % for calculating minipage widths
% Correct order of tables after \paragraph or \subparagraph
\usepackage{etoolbox}
\makeatletter
\patchcmd\longtable{\par}{\if@noskipsec\mbox{}\fi\par}{}{}
\makeatother
% Allow footnotes in longtable head/foot
\IfFileExists{footnotehyper.sty}{\usepackage{footnotehyper}}{\usepackage{footnote}}
\makesavenoteenv{longtable}
\usepackage{graphicx}
\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
\def\maxheight{\ifdim\Gin@nat@height>\textheight\textheight\else\Gin@nat@height\fi}
\makeatother
% Scale images if necessary, so that they will not overflow the page
% margins by default, and it is still possible to overwrite the defaults
% using explicit options in \includegraphics[width, height, ...]{}
\setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}
% Set default figure placement to htbp
\makeatletter
\def\fps@figure{htbp}
\makeatother

\usepackage{xr}
\usepackage[default]{sourcesanspro}
\usepackage{sourcecodepro}
\usepackage{fancyhdr}
\usepackage{fvextra}
\usepackage{dcolumn}
\fancypagestyle{plain}{\pagestyle{fancy}}
\renewcommand{\headrulewidth}{0pt}
\DefineVerbatimEnvironment{Highlighting}{Verbatim}{breaklines,commandchars=\\\{\}}
\KOMAoption{captions}{tableheading}
\makeatletter
\@ifpackageloaded{caption}{}{\usepackage{caption}}
\AtBeginDocument{%
\ifdefined\contentsname
  \renewcommand*\contentsname{Table of contents}
\else
  \newcommand\contentsname{Table of contents}
\fi
\ifdefined\listfigurename
  \renewcommand*\listfigurename{List of Figures}
\else
  \newcommand\listfigurename{List of Figures}
\fi
\ifdefined\listtablename
  \renewcommand*\listtablename{List of Tables}
\else
  \newcommand\listtablename{List of Tables}
\fi
\ifdefined\figurename
  \renewcommand*\figurename{Fig.}
\else
  \newcommand\figurename{Fig.}
\fi
\ifdefined\tablename
  \renewcommand*\tablename{Table}
\else
  \newcommand\tablename{Table}
\fi
}
\@ifpackageloaded{float}{}{\usepackage{float}}
\floatstyle{ruled}
\@ifundefined{c@chapter}{\newfloat{codelisting}{h}{lop}}{\newfloat{codelisting}{h}{lop}[chapter]}
\floatname{codelisting}{Listing}
\newcommand*\listoflistings{\listof{codelisting}{List of Listings}}
\makeatother
\makeatletter
\makeatother
\makeatletter
\@ifpackageloaded{caption}{}{\usepackage{caption}}
\@ifpackageloaded{subcaption}{}{\usepackage{subcaption}}
\makeatother
\ifLuaTeX
  \usepackage{selnolig}  % disable illegal ligatures
\fi
\usepackage{bookmark}

\IfFileExists{xurl.sty}{\usepackage{xurl}}{} % add URL line breaks if available
\urlstyle{same} % disable monospaced font for URLs
\hypersetup{
  colorlinks=true,
  linkcolor={blue},
  filecolor={Maroon},
  citecolor={Blue},
  urlcolor={Blue},
  pdfcreator={LaTeX via pandoc}}

\author{}
\date{}

\begin{document}

Stan codes for review. All Stan and R codes used in this study will be
deposited in a public repository after the review process.

\section{\texorpdfstring{Estimation of calibration coefficients
Co-\emph{a} and
Co-\emph{b}.}{Estimation of calibration coefficients Co-a and Co-b.}}\label{estimation-of-calibration-coefficients-co-a-and-co-b.}

\subsection{Model 1 (species-only
model)}\label{model-1-species-only-model}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{data}\NormalTok{ \{}
  \DataTypeTok{int}\NormalTok{\textless{}}\KeywordTok{lower}\NormalTok{=}\DecValTok{0}\NormalTok{\textgreater{} N; }\CommentTok{// number of data}
  \DataTypeTok{vector}\NormalTok{[N] log\_fd;}
  \DataTypeTok{vector}\NormalTok{[N] log\_k;}
\NormalTok{\}}

\KeywordTok{parameters}\NormalTok{ \{}
  \DataTypeTok{real}\NormalTok{\textless{}}\KeywordTok{lower}\NormalTok{=}\DecValTok{0}\NormalTok{\textgreater{} sigma;}
  \DataTypeTok{real}\NormalTok{ log\_a\_tilde;}
  \DataTypeTok{real}\NormalTok{ b\_tilde;}
\NormalTok{\}}

\KeywordTok{transformed parameters}\NormalTok{ \{}
  \DataTypeTok{real}\NormalTok{ log\_a = }\FloatTok{4.78}\NormalTok{ + }\FloatTok{2.5}\NormalTok{ * log\_a\_tilde;}
  \DataTypeTok{real}\NormalTok{ b = }\FloatTok{1.23}\NormalTok{ + }\FloatTok{2.5}\NormalTok{ * b\_tilde;}
\NormalTok{\}}

\KeywordTok{model}\NormalTok{ \{}
  \DataTypeTok{vector}\NormalTok{[N] mu;}
\NormalTok{  sigma \textasciitilde{} normal(}\DecValTok{0}\NormalTok{, }\FloatTok{2.5}\NormalTok{);}
\NormalTok{  log\_a\_tilde \textasciitilde{} std\_normal();}
\NormalTok{  b\_tilde \textasciitilde{} std\_normal();}
\NormalTok{  log\_fd \textasciitilde{} normal(log\_a + b * log\_k, sigma);}
\NormalTok{\}}

\KeywordTok{generated quantities}\NormalTok{ \{}
  \DataTypeTok{matrix}\NormalTok{[}\DecValTok{2}\NormalTok{, }\DecValTok{1}\NormalTok{] alpha;}
  \DataTypeTok{real}\NormalTok{ a = exp(log\_a + pow(sigma, }\DecValTok{2}\NormalTok{) / }\DecValTok{2}\NormalTok{);}
\NormalTok{  alpha[}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{] = log\_a;}
\NormalTok{  alpha[}\DecValTok{2}\NormalTok{, }\DecValTok{1}\NormalTok{] = b;}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\newpage

\subsection{Model 2 (segment-inclusive
model)}\label{model-2-segment-inclusive-model}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{data}\NormalTok{ \{}
  \DataTypeTok{int}\NormalTok{\textless{}}\KeywordTok{lower}\NormalTok{=}\DecValTok{0}\NormalTok{\textgreater{} N; }\CommentTok{// number of data}
  \DataTypeTok{int}\NormalTok{\textless{}}\KeywordTok{lower}\NormalTok{=}\DecValTok{0}\NormalTok{\textgreater{} J; }\CommentTok{// number of segments}
  \DataTypeTok{array}\NormalTok{[N] }\DataTypeTok{int}\NormalTok{\textless{}}\KeywordTok{lower}\NormalTok{=}\DecValTok{1}\NormalTok{,}\KeywordTok{upper}\NormalTok{=J\textgreater{} jj; }\CommentTok{// segements}
  \DataTypeTok{vector}\NormalTok{[N] y;}
  \DataTypeTok{matrix}\NormalTok{[N, }\DecValTok{2}\NormalTok{] x;}
  \DataTypeTok{matrix}\NormalTok{[}\DecValTok{1}\NormalTok{, J] u;}
\NormalTok{\}}

\KeywordTok{parameters}\NormalTok{ \{}
  \DataTypeTok{real}\NormalTok{\textless{}}\KeywordTok{lower}\NormalTok{=}\DecValTok{0}\NormalTok{\textgreater{} sigma;}
  \DataTypeTok{real}\NormalTok{ log\_a\_tilde;}
  \DataTypeTok{real}\NormalTok{ b\_tilde;}
  \DataTypeTok{matrix}\NormalTok{[}\DecValTok{2}\NormalTok{, J] z;}
  \DataTypeTok{cholesky\_factor\_corr}\NormalTok{[}\DecValTok{2}\NormalTok{] L\_Omega;}
  \DataTypeTok{vector}\NormalTok{\textless{}}\KeywordTok{lower}\NormalTok{=}\DecValTok{0}\NormalTok{\textgreater{}[}\DecValTok{2}\NormalTok{] tau;}
\NormalTok{\}}

\KeywordTok{transformed parameters}\NormalTok{ \{}
  \DataTypeTok{matrix}\NormalTok{[}\DecValTok{2}\NormalTok{, }\DecValTok{1}\NormalTok{] alpha;}
  \DataTypeTok{real}\NormalTok{ log\_a = }\FloatTok{4.78}\NormalTok{ + }\FloatTok{2.5}\NormalTok{ * log\_a\_tilde;}
  \DataTypeTok{real}\NormalTok{ b = }\FloatTok{1.23}\NormalTok{ + }\FloatTok{2.5}\NormalTok{ * b\_tilde;}
\NormalTok{  alpha[}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{] = log\_a;}
\NormalTok{  alpha[}\DecValTok{2}\NormalTok{, }\DecValTok{1}\NormalTok{] = b;}
  \DataTypeTok{matrix}\NormalTok{[}\DecValTok{2}\NormalTok{, J] A = alpha * u + diag\_pre\_multiply(tau, L\_Omega) * z;}
\NormalTok{\}}

\KeywordTok{model}\NormalTok{ \{}
 \DataTypeTok{vector}\NormalTok{[N] mu;}
  \ControlFlowTok{for}\NormalTok{(n }\ControlFlowTok{in} \DecValTok{1}\NormalTok{:N) \{}
\NormalTok{    mu[n] = x[n, ] * A[, jj[n]];}
\NormalTok{  \}}
\NormalTok{  tau \textasciitilde{} normal(}\DecValTok{0}\NormalTok{, }\FloatTok{2.5}\NormalTok{);}
\NormalTok{  to\_vector(z) \textasciitilde{} std\_normal();}
\NormalTok{  log\_a\_tilde \textasciitilde{} std\_normal();}
\NormalTok{  b\_tilde \textasciitilde{} std\_normal();}
\NormalTok{  L\_Omega \textasciitilde{} lkj\_corr\_cholesky(}\DecValTok{2}\NormalTok{);}
\NormalTok{  y \textasciitilde{} normal(mu, sigma);}
\NormalTok{\}}

\KeywordTok{generated quantities}\NormalTok{ \{}
  \DataTypeTok{real}\NormalTok{ a = exp(log\_a + pow(sigma, }\DecValTok{2}\NormalTok{) / }\DecValTok{2}\NormalTok{);}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\newpage

\subsection{Model 3 (species-xylem
model)}\label{model-3-species-xylem-model}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{data}\NormalTok{ \{}
  \DataTypeTok{int}\NormalTok{\textless{}}\KeywordTok{lower}\NormalTok{=}\DecValTok{0}\NormalTok{\textgreater{} N; }\CommentTok{// number of data}
  \DataTypeTok{int}\NormalTok{\textless{}}\KeywordTok{lower}\NormalTok{=}\DecValTok{0}\NormalTok{\textgreater{} K; }\CommentTok{// number of species}
  \DataTypeTok{int}\NormalTok{\textless{}}\KeywordTok{lower}\NormalTok{=}\DecValTok{0}\NormalTok{\textgreater{} L; }\CommentTok{// number of xylem types}
  \DataTypeTok{array}\NormalTok{[N] }\DataTypeTok{int}\NormalTok{\textless{}}\KeywordTok{lower}\NormalTok{=}\DecValTok{1}\NormalTok{,}\KeywordTok{upper}\NormalTok{=K\textgreater{} kk; }\CommentTok{// species}
  \DataTypeTok{array}\NormalTok{[N] }\DataTypeTok{int}\NormalTok{\textless{}}\KeywordTok{lower}\NormalTok{=}\DecValTok{1}\NormalTok{,}\KeywordTok{upper}\NormalTok{=L\textgreater{} ll; }\CommentTok{// xylem type}
  \DataTypeTok{vector}\NormalTok{[N] y;}
  \DataTypeTok{matrix}\NormalTok{[N, }\DecValTok{2}\NormalTok{] x;}
  \DataTypeTok{matrix}\NormalTok{[L, K] uk;}
  \DataTypeTok{matrix}\NormalTok{[}\DecValTok{1}\NormalTok{, L] ul;}
\NormalTok{\}}

\KeywordTok{parameters}\NormalTok{ \{}
  \DataTypeTok{real}\NormalTok{\textless{}}\KeywordTok{lower}\NormalTok{=}\DecValTok{0}\NormalTok{\textgreater{} sigma;}
  \DataTypeTok{real}\NormalTok{ log\_a\_tilde;}
  \DataTypeTok{real}\NormalTok{ b\_tilde;}
  \DataTypeTok{matrix}\NormalTok{[}\DecValTok{2}\NormalTok{, K] zk;}
  \DataTypeTok{matrix}\NormalTok{[}\DecValTok{2}\NormalTok{, L] zl;}
  \DataTypeTok{cholesky\_factor\_corr}\NormalTok{[}\DecValTok{2}\NormalTok{] L\_Omega\_k;}
  \DataTypeTok{cholesky\_factor\_corr}\NormalTok{[}\DecValTok{2}\NormalTok{] L\_Omega\_l;}
  \DataTypeTok{vector}\NormalTok{\textless{}}\KeywordTok{lower}\NormalTok{=}\DecValTok{0}\NormalTok{\textgreater{}[}\DecValTok{2}\NormalTok{] tau\_k;}
  \DataTypeTok{vector}\NormalTok{\textless{}}\KeywordTok{lower}\NormalTok{=}\DecValTok{0}\NormalTok{\textgreater{}[}\DecValTok{2}\NormalTok{] tau\_l;}
\NormalTok{\}}

\KeywordTok{transformed parameters}\NormalTok{ \{}
  \DataTypeTok{real}\NormalTok{ log\_a = }\FloatTok{4.78}\NormalTok{ + }\FloatTok{2.5}\NormalTok{ * log\_a\_tilde;}
  \DataTypeTok{real}\NormalTok{ b = }\FloatTok{1.23}\NormalTok{ + }\FloatTok{2.5}\NormalTok{ * b\_tilde;}
  \DataTypeTok{matrix}\NormalTok{[}\DecValTok{2}\NormalTok{, }\DecValTok{1}\NormalTok{] gamma;}
\NormalTok{  gamma[}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{] = log\_a;}
\NormalTok{  gamma[}\DecValTok{2}\NormalTok{, }\DecValTok{1}\NormalTok{] = b;}
  \DataTypeTok{matrix}\NormalTok{[}\DecValTok{2}\NormalTok{, L] beta = gamma * ul + diag\_pre\_multiply(tau\_l, L\_Omega\_l) * zl;}
  \DataTypeTok{matrix}\NormalTok{[}\DecValTok{2}\NormalTok{, K] alpha = beta * uk + diag\_pre\_multiply(tau\_k, L\_Omega\_k) * zk;}
\NormalTok{\}}

\KeywordTok{model}\NormalTok{ \{}
 \DataTypeTok{vector}\NormalTok{[N] mu;}
  \ControlFlowTok{for}\NormalTok{(n }\ControlFlowTok{in} \DecValTok{1}\NormalTok{:N) \{}
\NormalTok{    mu[n] = x[n, ] * alpha[, kk[n]];}
\NormalTok{  \}}
\NormalTok{  tau\_k \textasciitilde{} normal(}\DecValTok{0}\NormalTok{, }\FloatTok{2.5}\NormalTok{);}
\NormalTok{  tau\_l \textasciitilde{} normal(}\DecValTok{0}\NormalTok{, }\FloatTok{2.5}\NormalTok{);}
\NormalTok{  to\_vector(zk) \textasciitilde{} std\_normal();}
\NormalTok{  to\_vector(zl) \textasciitilde{} std\_normal();}
\NormalTok{  L\_Omega\_k \textasciitilde{} lkj\_corr\_cholesky(}\DecValTok{2}\NormalTok{);}
\NormalTok{  L\_Omega\_l \textasciitilde{} lkj\_corr\_cholesky(}\DecValTok{2}\NormalTok{);}
\NormalTok{  log\_a\_tilde \textasciitilde{} std\_normal();}
\NormalTok{  b\_tilde \textasciitilde{} std\_normal();}
\NormalTok{  y \textasciitilde{} normal(mu, sigma);}
\NormalTok{\}}

\KeywordTok{generated quantities}\NormalTok{ \{}
  \DataTypeTok{vector}\NormalTok{[K] a = exp(to\_vector(alpha[}\DecValTok{1}\NormalTok{, ]) + pow(sigma, }\DecValTok{2}\NormalTok{) / }\DecValTok{2}\NormalTok{);}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\newpage

\subsection{Model 4 (segment-xylem
model)}\label{model-4-segment-xylem-model}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{data}\NormalTok{ \{}
  \DataTypeTok{int}\NormalTok{\textless{}}\KeywordTok{lower}\NormalTok{=}\DecValTok{0}\NormalTok{\textgreater{} N; }\CommentTok{// number of data}
  \DataTypeTok{int}\NormalTok{\textless{}}\KeywordTok{lower}\NormalTok{=}\DecValTok{0}\NormalTok{\textgreater{} J; }\CommentTok{// number of tree samples}
  \DataTypeTok{int}\NormalTok{\textless{}}\KeywordTok{lower}\NormalTok{=}\DecValTok{0}\NormalTok{\textgreater{} K; }\CommentTok{// number of species}
  \DataTypeTok{int}\NormalTok{\textless{}}\KeywordTok{lower}\NormalTok{=}\DecValTok{0}\NormalTok{\textgreater{} L; }\CommentTok{// number of xylem types}
  \DataTypeTok{array}\NormalTok{[N] }\DataTypeTok{int}\NormalTok{\textless{}}\KeywordTok{lower}\NormalTok{=}\DecValTok{1}\NormalTok{,}\KeywordTok{upper}\NormalTok{=J\textgreater{} jj; }\CommentTok{// tree sample}
  \DataTypeTok{array}\NormalTok{[N] }\DataTypeTok{int}\NormalTok{\textless{}}\KeywordTok{lower}\NormalTok{=}\DecValTok{1}\NormalTok{,}\KeywordTok{upper}\NormalTok{=K\textgreater{} kk; }\CommentTok{// species}
  \DataTypeTok{array}\NormalTok{[N] }\DataTypeTok{int}\NormalTok{\textless{}}\KeywordTok{lower}\NormalTok{=}\DecValTok{1}\NormalTok{,}\KeywordTok{upper}\NormalTok{=L\textgreater{} ll; }\CommentTok{// xylem type}
  \DataTypeTok{vector}\NormalTok{[N] y;}
  \DataTypeTok{matrix}\NormalTok{[N, }\DecValTok{2}\NormalTok{] x;}
  \DataTypeTok{matrix}\NormalTok{[K, J] uj;}
  \DataTypeTok{matrix}\NormalTok{[L, K] uk;}
  \DataTypeTok{matrix}\NormalTok{[}\DecValTok{1}\NormalTok{, L] ul;}
\NormalTok{\}}

\KeywordTok{parameters}\NormalTok{ \{}
  \DataTypeTok{real}\NormalTok{\textless{}}\KeywordTok{lower}\NormalTok{=}\DecValTok{0}\NormalTok{\textgreater{} sigma;}
  \DataTypeTok{real}\NormalTok{ log\_a\_tilde;}
  \DataTypeTok{real}\NormalTok{ b\_tilde;}
  \DataTypeTok{matrix}\NormalTok{[}\DecValTok{2}\NormalTok{, J] zj;}
  \DataTypeTok{matrix}\NormalTok{[}\DecValTok{2}\NormalTok{, K] zk;}
  \DataTypeTok{matrix}\NormalTok{[}\DecValTok{2}\NormalTok{, L] zl;}
  \DataTypeTok{cholesky\_factor\_corr}\NormalTok{[}\DecValTok{2}\NormalTok{] L\_Omega\_j;}
  \DataTypeTok{cholesky\_factor\_corr}\NormalTok{[}\DecValTok{2}\NormalTok{] L\_Omega\_k;}
  \DataTypeTok{cholesky\_factor\_corr}\NormalTok{[}\DecValTok{2}\NormalTok{] L\_Omega\_l;}
  \DataTypeTok{vector}\NormalTok{\textless{}}\KeywordTok{lower}\NormalTok{=}\DecValTok{0}\NormalTok{\textgreater{}[}\DecValTok{2}\NormalTok{] tau\_j;}
  \DataTypeTok{vector}\NormalTok{\textless{}}\KeywordTok{lower}\NormalTok{=}\DecValTok{0}\NormalTok{\textgreater{}[}\DecValTok{2}\NormalTok{] tau\_k;}
  \DataTypeTok{vector}\NormalTok{\textless{}}\KeywordTok{lower}\NormalTok{=}\DecValTok{0}\NormalTok{\textgreater{}[}\DecValTok{2}\NormalTok{] tau\_l;}
\NormalTok{\}}

\KeywordTok{transformed parameters}\NormalTok{ \{}
  \DataTypeTok{real}\NormalTok{ log\_a = }\FloatTok{4.78}\NormalTok{ + }\FloatTok{2.5}\NormalTok{ * log\_a\_tilde;}
  \DataTypeTok{real}\NormalTok{ b = }\FloatTok{1.23}\NormalTok{ + }\FloatTok{2.5}\NormalTok{ * b\_tilde;}
  \DataTypeTok{matrix}\NormalTok{[}\DecValTok{2}\NormalTok{, }\DecValTok{1}\NormalTok{] gamma;}
\NormalTok{  gamma[}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{] = log\_a;}
\NormalTok{  gamma[}\DecValTok{2}\NormalTok{, }\DecValTok{1}\NormalTok{] = b;}
  \DataTypeTok{matrix}\NormalTok{[}\DecValTok{2}\NormalTok{, L] beta = gamma * ul + diag\_pre\_multiply(tau\_l, L\_Omega\_l) * zl;}
  \DataTypeTok{matrix}\NormalTok{[}\DecValTok{2}\NormalTok{, K] alpha = beta * uk + diag\_pre\_multiply(tau\_k, L\_Omega\_k) * zk;}
  \DataTypeTok{matrix}\NormalTok{[}\DecValTok{2}\NormalTok{, J] A = alpha * uj + diag\_pre\_multiply(tau\_j, L\_Omega\_j) * zj;}
\NormalTok{\}}

\KeywordTok{model}\NormalTok{ \{}
 \DataTypeTok{vector}\NormalTok{[N] mu;}
  \ControlFlowTok{for}\NormalTok{(n }\ControlFlowTok{in} \DecValTok{1}\NormalTok{:N) \{}
\NormalTok{    mu[n] = x[n, ] * A[, jj[n]];}
\NormalTok{  \}}
\NormalTok{  tau\_j \textasciitilde{} normal(}\DecValTok{0}\NormalTok{, }\FloatTok{2.5}\NormalTok{);}
\NormalTok{  tau\_k \textasciitilde{} normal(}\DecValTok{0}\NormalTok{, }\FloatTok{2.5}\NormalTok{);}
\NormalTok{  tau\_l \textasciitilde{} normal(}\DecValTok{0}\NormalTok{, }\FloatTok{2.5}\NormalTok{);}
\NormalTok{  to\_vector(zl) \textasciitilde{} std\_normal();}
\NormalTok{  to\_vector(zk) \textasciitilde{} std\_normal();}
\NormalTok{  to\_vector(zj) \textasciitilde{} std\_normal();}
\NormalTok{  L\_Omega\_l \textasciitilde{} lkj\_corr\_cholesky(}\DecValTok{2}\NormalTok{);}
\NormalTok{  L\_Omega\_k \textasciitilde{} lkj\_corr\_cholesky(}\DecValTok{2}\NormalTok{);}
\NormalTok{  L\_Omega\_j \textasciitilde{} lkj\_corr\_cholesky(}\DecValTok{2}\NormalTok{);}
\NormalTok{  log\_a\_tilde \textasciitilde{} std\_normal();}
\NormalTok{  b\_tilde \textasciitilde{} std\_normal();}
\NormalTok{  y \textasciitilde{} normal(mu, sigma);}
\NormalTok{\}}

\KeywordTok{generated quantities}\NormalTok{ \{}
  \DataTypeTok{cov\_matrix}\NormalTok{[}\DecValTok{2}\NormalTok{] Sigma\_j = diag\_pre\_multiply(tau\_j, L\_Omega\_j) *}
\NormalTok{    diag\_post\_multiply(L\_Omega\_j\textquotesingle{}, tau\_j);}
  \DataTypeTok{cov\_matrix}\NormalTok{[}\DecValTok{2}\NormalTok{] Sigma\_k = diag\_pre\_multiply(tau\_k, L\_Omega\_k) *}
\NormalTok{    diag\_post\_multiply(L\_Omega\_k\textquotesingle{}, tau\_k);}
  \DataTypeTok{cov\_matrix}\NormalTok{[}\DecValTok{2}\NormalTok{] Sigma\_l = diag\_pre\_multiply(tau\_l, L\_Omega\_l) *}
\NormalTok{    diag\_post\_multiply(L\_Omega\_l\textquotesingle{}, tau\_l);}
  \DataTypeTok{real}\NormalTok{\textless{}}\KeywordTok{lower}\NormalTok{={-}}\DecValTok{1}\NormalTok{, }\KeywordTok{upper}\NormalTok{=}\DecValTok{1}\NormalTok{\textgreater{} rho\_j = Sigma\_j[}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{] * inv(tau\_j[}\DecValTok{1}\NormalTok{] * tau\_j[}\DecValTok{2}\NormalTok{]);}
  \DataTypeTok{real}\NormalTok{\textless{}}\KeywordTok{lower}\NormalTok{={-}}\DecValTok{1}\NormalTok{, }\KeywordTok{upper}\NormalTok{=}\DecValTok{1}\NormalTok{\textgreater{} rho\_k = Sigma\_k[}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{] * inv(tau\_k[}\DecValTok{1}\NormalTok{] * tau\_k[}\DecValTok{2}\NormalTok{]);}
  \DataTypeTok{real}\NormalTok{\textless{}}\KeywordTok{lower}\NormalTok{={-}}\DecValTok{1}\NormalTok{, }\KeywordTok{upper}\NormalTok{=}\DecValTok{1}\NormalTok{\textgreater{} rho\_l = Sigma\_l[}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{] * inv(tau\_l[}\DecValTok{1}\NormalTok{] * tau\_l[}\DecValTok{2}\NormalTok{]);}
  \DataTypeTok{vector}\NormalTok{[K] a = exp(to\_vector(alpha[}\DecValTok{1}\NormalTok{, ]) + pow(sigma, }\DecValTok{2}\NormalTok{) / }\DecValTok{2}\NormalTok{);}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\newpage

\subsection{Model 4a (Model 4 with segement-level
traits)}\label{model-4a-model-4-with-segement-level-traits}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{data}\NormalTok{ \{}
  \DataTypeTok{int}\NormalTok{\textless{}}\KeywordTok{lower}\NormalTok{=}\DecValTok{0}\NormalTok{\textgreater{} N; }\CommentTok{// number of data}
  \DataTypeTok{int}\NormalTok{\textless{}}\KeywordTok{lower}\NormalTok{=}\DecValTok{0}\NormalTok{\textgreater{} J; }\CommentTok{// number of tree samples}
  \DataTypeTok{int}\NormalTok{\textless{}}\KeywordTok{lower}\NormalTok{=}\DecValTok{0}\NormalTok{\textgreater{} K; }\CommentTok{// number of species}
  \DataTypeTok{int}\NormalTok{\textless{}}\KeywordTok{lower}\NormalTok{=}\DecValTok{0}\NormalTok{\textgreater{} L; }\CommentTok{// number of xylem types}
  \DataTypeTok{int}\NormalTok{\textless{}}\KeywordTok{lower}\NormalTok{=}\DecValTok{0}\NormalTok{\textgreater{} T; }\CommentTok{// number of trait predcitors}
  \DataTypeTok{array}\NormalTok{[N] }\DataTypeTok{int}\NormalTok{\textless{}}\KeywordTok{lower}\NormalTok{=}\DecValTok{1}\NormalTok{, }\KeywordTok{upper}\NormalTok{=J\textgreater{} jj; }\CommentTok{// tree sample}
  \DataTypeTok{vector}\NormalTok{[N] y;}
  \DataTypeTok{matrix}\NormalTok{[N, }\DecValTok{2}\NormalTok{] x;}
  \DataTypeTok{matrix}\NormalTok{[J, T] xj; }\CommentTok{// trait {-} segment}
  \DataTypeTok{matrix}\NormalTok{[K, J] uj;}
  \DataTypeTok{matrix}\NormalTok{[L, K] uk;}
  \DataTypeTok{matrix}\NormalTok{[}\DecValTok{1}\NormalTok{, L] ul;}
\NormalTok{\}}

\KeywordTok{parameters}\NormalTok{ \{}
  \DataTypeTok{real}\NormalTok{\textless{}}\KeywordTok{lower}\NormalTok{=}\DecValTok{0}\NormalTok{\textgreater{} sigma;}
  \DataTypeTok{vector}\NormalTok{[}\DecValTok{4}\NormalTok{] gamma;}
  \DataTypeTok{matrix}\NormalTok{[}\DecValTok{2}\NormalTok{, J] zj;}
  \DataTypeTok{matrix}\NormalTok{[}\DecValTok{4}\NormalTok{, K] zk;}
  \DataTypeTok{matrix}\NormalTok{[}\DecValTok{4}\NormalTok{, L] zl;}
  \DataTypeTok{cholesky\_factor\_corr}\NormalTok{[}\DecValTok{2}\NormalTok{] L\_Omega\_j;}
  \DataTypeTok{cholesky\_factor\_corr}\NormalTok{[}\DecValTok{4}\NormalTok{] L\_Omega\_k;}
  \DataTypeTok{cholesky\_factor\_corr}\NormalTok{[}\DecValTok{4}\NormalTok{] L\_Omega\_l;}
  \DataTypeTok{vector}\NormalTok{\textless{}}\KeywordTok{lower}\NormalTok{=}\DecValTok{0}\NormalTok{\textgreater{}[}\DecValTok{2}\NormalTok{] tau\_j;}
  \DataTypeTok{vector}\NormalTok{\textless{}}\KeywordTok{lower}\NormalTok{=}\DecValTok{0}\NormalTok{\textgreater{}[}\DecValTok{4}\NormalTok{] tau\_k;}
  \DataTypeTok{vector}\NormalTok{\textless{}}\KeywordTok{lower}\NormalTok{=}\DecValTok{0}\NormalTok{\textgreater{}[}\DecValTok{4}\NormalTok{] tau\_l;}
\NormalTok{\}}

\CommentTok{// simple}
\KeywordTok{transformed parameters}\NormalTok{ \{}
  \CommentTok{// Multiplying to apply hyper{-}xylem to xylem mapping and adding errors}
  \DataTypeTok{matrix}\NormalTok{[}\DecValTok{4}\NormalTok{, L] beta = gamma * to\_row\_vector(ul) + diag\_pre\_multiply(tau\_l, L\_Omega\_l) * zl;}
  \CommentTok{// Multiplying to apply hyper{-}species to species mapping and adding errors}
  \DataTypeTok{matrix}\NormalTok{[}\DecValTok{4}\NormalTok{, K] alpha = beta * uk + diag\_pre\_multiply(tau\_k, L\_Omega\_k) * zk;}
  \CommentTok{// Multiplying to apply species to tree sample mapping}
  \DataTypeTok{matrix}\NormalTok{[T, J] alpha\_a = alpha[}\DecValTok{1}\NormalTok{:}\DecValTok{2}\NormalTok{, ] * uj;}
  \DataTypeTok{matrix}\NormalTok{[T, J] alpha\_b = alpha[}\DecValTok{3}\NormalTok{:}\DecValTok{4}\NormalTok{, ] * uj;}

  \CommentTok{// Calculate the final effects per tree sample, incorporating trait predictors}
  \DataTypeTok{row\_vector}\NormalTok{[J] mu\_a = to\_row\_vector(diagonal(xj * alpha\_a));}
  \DataTypeTok{row\_vector}\NormalTok{[J] mu\_b = to\_row\_vector(diagonal(xj * alpha\_b));}

  \DataTypeTok{matrix}\NormalTok{[}\DecValTok{2}\NormalTok{, J] A = to\_matrix(append\_row(mu\_a, mu\_b)) + diag\_pre\_multiply(tau\_j, L\_Omega\_j) * zj;}

\NormalTok{\}}

\KeywordTok{model}\NormalTok{ \{}
  \DataTypeTok{vector}\NormalTok{[N] mu;}
  \ControlFlowTok{for}\NormalTok{ (n }\ControlFlowTok{in} \DecValTok{1}\NormalTok{:N) \{}
\NormalTok{    mu[n] = x[n, ] * A[, jj[n]];}
\NormalTok{  \}}

\NormalTok{  to\_vector(zl) \textasciitilde{} std\_normal();}
\NormalTok{  to\_vector(zk) \textasciitilde{} std\_normal();}
\NormalTok{  to\_vector(zj) \textasciitilde{} std\_normal();}
\NormalTok{  tau\_l \textasciitilde{} normal(}\DecValTok{0}\NormalTok{, }\FloatTok{2.5}\NormalTok{);}
\NormalTok{  tau\_k \textasciitilde{} normal(}\DecValTok{0}\NormalTok{, }\FloatTok{2.5}\NormalTok{);}
\NormalTok{  tau\_j \textasciitilde{} normal(}\DecValTok{0}\NormalTok{, }\FloatTok{2.5}\NormalTok{);}
\NormalTok{  L\_Omega\_l \textasciitilde{} lkj\_corr\_cholesky(}\DecValTok{2}\NormalTok{);}
\NormalTok{  L\_Omega\_k \textasciitilde{} lkj\_corr\_cholesky(}\DecValTok{2}\NormalTok{);}
\NormalTok{  L\_Omega\_j \textasciitilde{} lkj\_corr\_cholesky(}\DecValTok{2}\NormalTok{);}

\NormalTok{  to\_vector(gamma) \textasciitilde{} normal(}\DecValTok{0}\NormalTok{, }\DecValTok{5}\NormalTok{);}
\NormalTok{  y \textasciitilde{} normal(mu, sigma);}
\NormalTok{\}}

\KeywordTok{generated quantities}\NormalTok{ \{}
  \DataTypeTok{vector}\NormalTok{[N] log\_lik;}
  \DataTypeTok{vector}\NormalTok{[N] mu;}
  \ControlFlowTok{for}\NormalTok{ (n }\ControlFlowTok{in} \DecValTok{1}\NormalTok{:N) \{}
\NormalTok{    mu[n] = x[n, ] * A[, jj[n]];}
\NormalTok{    log\_lik[n] = normal\_lpdf(y[n] | mu[n], sigma);}
\NormalTok{  \}}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\newpage

\subsection{Model 4b (Model 4a without
xylem)}\label{model-4b-model-4a-without-xylem}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{data}\NormalTok{ \{}
  \DataTypeTok{int}\NormalTok{\textless{}}\KeywordTok{lower}\NormalTok{=}\DecValTok{0}\NormalTok{\textgreater{} N; }\CommentTok{// number of data}
  \DataTypeTok{int}\NormalTok{\textless{}}\KeywordTok{lower}\NormalTok{=}\DecValTok{0}\NormalTok{\textgreater{} J; }\CommentTok{// number of tree samples}
  \DataTypeTok{int}\NormalTok{\textless{}}\KeywordTok{lower}\NormalTok{=}\DecValTok{0}\NormalTok{\textgreater{} K; }\CommentTok{// number of species}
  \DataTypeTok{int}\NormalTok{\textless{}}\KeywordTok{lower}\NormalTok{=}\DecValTok{0}\NormalTok{\textgreater{} T; }\CommentTok{// number of trait predcitors}
  \DataTypeTok{array}\NormalTok{[N] }\DataTypeTok{int}\NormalTok{\textless{}}\KeywordTok{lower}\NormalTok{=}\DecValTok{1}\NormalTok{, }\KeywordTok{upper}\NormalTok{=J\textgreater{} jj; }\CommentTok{// tree sample}
  \DataTypeTok{vector}\NormalTok{[N] y;}
  \DataTypeTok{matrix}\NormalTok{[N, }\DecValTok{2}\NormalTok{] x;}
  \DataTypeTok{matrix}\NormalTok{[J, T] xj; }\CommentTok{// trait {-} segment}
  \DataTypeTok{matrix}\NormalTok{[K, J] uj;}
  \DataTypeTok{matrix}\NormalTok{[}\DecValTok{1}\NormalTok{, K] uk;}
\NormalTok{\}}

\KeywordTok{parameters}\NormalTok{ \{}
  \DataTypeTok{real}\NormalTok{\textless{}}\KeywordTok{lower}\NormalTok{=}\DecValTok{0}\NormalTok{\textgreater{} sigma;}
  \DataTypeTok{vector}\NormalTok{[}\DecValTok{4}\NormalTok{] beta;}
  \DataTypeTok{matrix}\NormalTok{[}\DecValTok{2}\NormalTok{, J] zj;}
  \DataTypeTok{matrix}\NormalTok{[}\DecValTok{4}\NormalTok{, K] zk;}
  \DataTypeTok{cholesky\_factor\_corr}\NormalTok{[}\DecValTok{2}\NormalTok{] L\_Omega\_j;}
  \DataTypeTok{cholesky\_factor\_corr}\NormalTok{[}\DecValTok{4}\NormalTok{] L\_Omega\_k;}
  \DataTypeTok{vector}\NormalTok{\textless{}}\KeywordTok{lower}\NormalTok{=}\DecValTok{0}\NormalTok{\textgreater{}[}\DecValTok{2}\NormalTok{] tau\_j;}
  \DataTypeTok{vector}\NormalTok{\textless{}}\KeywordTok{lower}\NormalTok{=}\DecValTok{0}\NormalTok{\textgreater{}[}\DecValTok{4}\NormalTok{] tau\_k;}
\NormalTok{\}}

\CommentTok{// simple}
\KeywordTok{transformed parameters}\NormalTok{ \{}
  \CommentTok{// Multiplying to apply hyper{-}species to species mapping and adding errors}
  \DataTypeTok{matrix}\NormalTok{[}\DecValTok{4}\NormalTok{, K] alpha = beta * to\_row\_vector(uk) + diag\_pre\_multiply(tau\_k, L\_Omega\_k) * zk;}
  \CommentTok{// Multiplying to apply species to tree sample mapping}
  \DataTypeTok{matrix}\NormalTok{[T, J] alpha\_a = alpha[}\DecValTok{1}\NormalTok{:}\DecValTok{2}\NormalTok{, ] * uj;}
  \DataTypeTok{matrix}\NormalTok{[T, J] alpha\_b = alpha[}\DecValTok{3}\NormalTok{:}\DecValTok{4}\NormalTok{, ] * uj;}

  \CommentTok{// Calculate the final effects per tree sample, incorporating trait predictors}
  \DataTypeTok{row\_vector}\NormalTok{[J] mu\_a = to\_row\_vector(diagonal(xj * alpha\_a));}
  \DataTypeTok{row\_vector}\NormalTok{[J] mu\_b = to\_row\_vector(diagonal(xj * alpha\_b));}

  \DataTypeTok{matrix}\NormalTok{[}\DecValTok{2}\NormalTok{, J] A = to\_matrix(append\_row(mu\_a, mu\_b)) + diag\_pre\_multiply(tau\_j, L\_Omega\_j) * zj;}

\NormalTok{\}}

\KeywordTok{model}\NormalTok{ \{}
  \DataTypeTok{vector}\NormalTok{[N] mu;}
  \ControlFlowTok{for}\NormalTok{ (n }\ControlFlowTok{in} \DecValTok{1}\NormalTok{:N) \{}
\NormalTok{    mu[n] = x[n, ] * A[, jj[n]];}
\NormalTok{  \}}

\NormalTok{  to\_vector(zk) \textasciitilde{} std\_normal();}
\NormalTok{  to\_vector(zj) \textasciitilde{} std\_normal();}
\NormalTok{  tau\_k \textasciitilde{} normal(}\DecValTok{0}\NormalTok{, }\FloatTok{2.5}\NormalTok{);}
\NormalTok{  tau\_j \textasciitilde{} normal(}\DecValTok{0}\NormalTok{, }\FloatTok{2.5}\NormalTok{);}
\NormalTok{  L\_Omega\_k \textasciitilde{} lkj\_corr\_cholesky(}\DecValTok{2}\NormalTok{);}
\NormalTok{  L\_Omega\_j \textasciitilde{} lkj\_corr\_cholesky(}\DecValTok{2}\NormalTok{);}

\NormalTok{  to\_vector(beta) \textasciitilde{} normal(}\DecValTok{0}\NormalTok{, }\DecValTok{5}\NormalTok{);}
\NormalTok{  y \textasciitilde{} normal(mu, sigma);}
\NormalTok{\}}

\KeywordTok{generated quantities}\NormalTok{ \{}
  \DataTypeTok{vector}\NormalTok{[N] log\_lik;}
  \DataTypeTok{vector}\NormalTok{[N] mu;}
  \ControlFlowTok{for}\NormalTok{ (n }\ControlFlowTok{in} \DecValTok{1}\NormalTok{:N) \{}
\NormalTok{    mu[n] = x[n, ] * A[, jj[n]];}
\NormalTok{    log\_lik[n] = normal\_lpdf(y[n] | mu[n], sigma);}
\NormalTok{  \}}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\newpage

\subsection{Model 4c (Model 4a with sp-level
traits)}\label{model-4c-model-4a-with-sp-level-traits}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{data}\NormalTok{ \{}
  \DataTypeTok{int}\NormalTok{\textless{}}\KeywordTok{lower}\NormalTok{=}\DecValTok{0}\NormalTok{\textgreater{} N; }\CommentTok{// number of data}
  \DataTypeTok{int}\NormalTok{\textless{}}\KeywordTok{lower}\NormalTok{=}\DecValTok{0}\NormalTok{\textgreater{} J; }\CommentTok{// number of tree samples}
  \DataTypeTok{int}\NormalTok{\textless{}}\KeywordTok{lower}\NormalTok{=}\DecValTok{0}\NormalTok{\textgreater{} K; }\CommentTok{// number of species}
  \DataTypeTok{int}\NormalTok{\textless{}}\KeywordTok{lower}\NormalTok{=}\DecValTok{0}\NormalTok{\textgreater{} L; }\CommentTok{// number of xylem types}
  \DataTypeTok{int}\NormalTok{\textless{}}\KeywordTok{lower}\NormalTok{=}\DecValTok{0}\NormalTok{\textgreater{} T; }\CommentTok{// number of trait predcitors}
  \DataTypeTok{array}\NormalTok{[N] }\DataTypeTok{int}\NormalTok{\textless{}}\KeywordTok{lower}\NormalTok{=}\DecValTok{1}\NormalTok{, }\KeywordTok{upper}\NormalTok{=J\textgreater{} jj; }\CommentTok{// tree sample}
  \DataTypeTok{vector}\NormalTok{[N] y;}
  \DataTypeTok{matrix}\NormalTok{[N, }\DecValTok{2}\NormalTok{] x;}
  \DataTypeTok{matrix}\NormalTok{[K, T] xk; }\CommentTok{// trait {-} species}
  \DataTypeTok{matrix}\NormalTok{[K, J] uj;}
  \DataTypeTok{matrix}\NormalTok{[L, K] uk;}
  \DataTypeTok{matrix}\NormalTok{[}\DecValTok{1}\NormalTok{, L] ul;}
\NormalTok{\}}

\KeywordTok{parameters}\NormalTok{ \{}
  \DataTypeTok{real}\NormalTok{\textless{}}\KeywordTok{lower}\NormalTok{=}\DecValTok{0}\NormalTok{\textgreater{} sigma;}
  \DataTypeTok{vector}\NormalTok{[}\DecValTok{4}\NormalTok{] gamma;}
  \DataTypeTok{matrix}\NormalTok{[}\DecValTok{2}\NormalTok{, J] zj;}
  \DataTypeTok{matrix}\NormalTok{[}\DecValTok{2}\NormalTok{, K] zk;}
  \DataTypeTok{matrix}\NormalTok{[}\DecValTok{4}\NormalTok{, L] zl;}
  \DataTypeTok{cholesky\_factor\_corr}\NormalTok{[}\DecValTok{2}\NormalTok{] L\_Omega\_j;}
  \DataTypeTok{cholesky\_factor\_corr}\NormalTok{[}\DecValTok{2}\NormalTok{] L\_Omega\_k;}
  \DataTypeTok{cholesky\_factor\_corr}\NormalTok{[}\DecValTok{4}\NormalTok{] L\_Omega\_l;}
  \DataTypeTok{vector}\NormalTok{\textless{}}\KeywordTok{lower}\NormalTok{=}\DecValTok{0}\NormalTok{\textgreater{}[}\DecValTok{2}\NormalTok{] tau\_j;}
  \DataTypeTok{vector}\NormalTok{\textless{}}\KeywordTok{lower}\NormalTok{=}\DecValTok{0}\NormalTok{\textgreater{}[}\DecValTok{2}\NormalTok{] tau\_k;}
  \DataTypeTok{vector}\NormalTok{\textless{}}\KeywordTok{lower}\NormalTok{=}\DecValTok{0}\NormalTok{\textgreater{}[}\DecValTok{4}\NormalTok{] tau\_l;}
\NormalTok{\}}

\CommentTok{// simple}
\KeywordTok{transformed parameters}\NormalTok{ \{}
  \CommentTok{// Multiplying to apply hyper{-}xylem to xylem mapping and adding errors}
  \DataTypeTok{matrix}\NormalTok{[}\DecValTok{4}\NormalTok{, L] beta = gamma * to\_row\_vector(ul) + diag\_pre\_multiply(tau\_l, L\_Omega\_l) * zl;}

  \CommentTok{// Calculate the effects per species, incorporating trait predictors}
  \DataTypeTok{matrix}\NormalTok{[}\DecValTok{4}\NormalTok{, K] alpha\_hat = beta * uk;}
  \DataTypeTok{row\_vector}\NormalTok{[K] alpha\_a = to\_row\_vector(diagonal(xk * alpha\_hat[}\DecValTok{1}\NormalTok{:}\DecValTok{2}\NormalTok{, ]));}
  \DataTypeTok{row\_vector}\NormalTok{[K] alpha\_b = to\_row\_vector(diagonal(xk * alpha\_hat[}\DecValTok{3}\NormalTok{:}\DecValTok{4}\NormalTok{, ]));}
  \DataTypeTok{matrix}\NormalTok{[}\DecValTok{2}\NormalTok{, K] alpha = to\_matrix(append\_row(alpha\_a, alpha\_b)) + diag\_pre\_multiply(tau\_k, L\_Omega\_k) * zk;}

  \CommentTok{// Multiplying to apply species to segments mapping and adding errors}
  \DataTypeTok{matrix}\NormalTok{[}\DecValTok{2}\NormalTok{, J] A = alpha * uj + diag\_pre\_multiply(tau\_j, L\_Omega\_j) * zj;}

\NormalTok{\}}

\KeywordTok{model}\NormalTok{ \{}
  \DataTypeTok{vector}\NormalTok{[N] mu;}
  \ControlFlowTok{for}\NormalTok{ (n }\ControlFlowTok{in} \DecValTok{1}\NormalTok{:N) \{}
\NormalTok{    mu[n] = x[n, ] * A[, jj[n]];}
\NormalTok{  \}}

\NormalTok{  to\_vector(zl) \textasciitilde{} std\_normal();}
\NormalTok{  to\_vector(zk) \textasciitilde{} std\_normal();}
\NormalTok{  to\_vector(zj) \textasciitilde{} std\_normal();}
\NormalTok{  tau\_l \textasciitilde{} normal(}\DecValTok{0}\NormalTok{, }\FloatTok{2.5}\NormalTok{);}
\NormalTok{  tau\_k \textasciitilde{} normal(}\DecValTok{0}\NormalTok{, }\FloatTok{2.5}\NormalTok{);}
\NormalTok{  tau\_j \textasciitilde{} normal(}\DecValTok{0}\NormalTok{, }\FloatTok{2.5}\NormalTok{);}
\NormalTok{  L\_Omega\_l \textasciitilde{} lkj\_corr\_cholesky(}\DecValTok{2}\NormalTok{);}
\NormalTok{  L\_Omega\_k \textasciitilde{} lkj\_corr\_cholesky(}\DecValTok{2}\NormalTok{);}
\NormalTok{  L\_Omega\_j \textasciitilde{} lkj\_corr\_cholesky(}\DecValTok{2}\NormalTok{);}

\NormalTok{  to\_vector(gamma) \textasciitilde{} normal(}\DecValTok{0}\NormalTok{, }\DecValTok{5}\NormalTok{);}
\NormalTok{  y \textasciitilde{} normal(mu, sigma);}
\NormalTok{\}}

\KeywordTok{generated quantities}\NormalTok{ \{}
  \DataTypeTok{vector}\NormalTok{[N] log\_lik;}
  \DataTypeTok{vector}\NormalTok{[N] mu;}
  \ControlFlowTok{for}\NormalTok{ (n }\ControlFlowTok{in} \DecValTok{1}\NormalTok{:N) \{}
\NormalTok{    mu[n] = x[n, ] * A[, jj[n]];}
\NormalTok{    log\_lik[n] = normal\_lpdf(y[n] | mu[n], sigma);}
\NormalTok{  \}}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\newpage

\subsection{Model 4d (Model 4b with sp-level
traits)}\label{model-4d-model-4b-with-sp-level-traits}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{data}\NormalTok{ \{}
  \DataTypeTok{int}\NormalTok{\textless{}}\KeywordTok{lower}\NormalTok{=}\DecValTok{0}\NormalTok{\textgreater{} N; }\CommentTok{// number of data}
  \DataTypeTok{int}\NormalTok{\textless{}}\KeywordTok{lower}\NormalTok{=}\DecValTok{0}\NormalTok{\textgreater{} J; }\CommentTok{// number of tree samples}
  \DataTypeTok{int}\NormalTok{\textless{}}\KeywordTok{lower}\NormalTok{=}\DecValTok{0}\NormalTok{\textgreater{} K; }\CommentTok{// number of species}
  \DataTypeTok{int}\NormalTok{\textless{}}\KeywordTok{lower}\NormalTok{=}\DecValTok{0}\NormalTok{\textgreater{} T; }\CommentTok{// number of trait predcitors}
  \DataTypeTok{array}\NormalTok{[N] }\DataTypeTok{int}\NormalTok{\textless{}}\KeywordTok{lower}\NormalTok{=}\DecValTok{1}\NormalTok{, }\KeywordTok{upper}\NormalTok{=J\textgreater{} jj; }\CommentTok{// tree sample}
  \DataTypeTok{vector}\NormalTok{[N] y;}
  \DataTypeTok{matrix}\NormalTok{[N, }\DecValTok{2}\NormalTok{] x;}
  \DataTypeTok{matrix}\NormalTok{[K, T] xk; }\CommentTok{// trait {-} species}
  \DataTypeTok{matrix}\NormalTok{[K, J] uj;}
  \DataTypeTok{matrix}\NormalTok{[}\DecValTok{1}\NormalTok{, K] uk;}
\NormalTok{\}}

\KeywordTok{parameters}\NormalTok{ \{}
  \DataTypeTok{real}\NormalTok{\textless{}}\KeywordTok{lower}\NormalTok{=}\DecValTok{0}\NormalTok{\textgreater{} sigma;}
  \DataTypeTok{matrix}\NormalTok{[}\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{] beta;}
  \DataTypeTok{matrix}\NormalTok{[}\DecValTok{2}\NormalTok{, J] zj;}
  \DataTypeTok{matrix}\NormalTok{[}\DecValTok{2}\NormalTok{, K] zk;}
  \DataTypeTok{cholesky\_factor\_corr}\NormalTok{[}\DecValTok{2}\NormalTok{] L\_Omega\_j;}
  \DataTypeTok{cholesky\_factor\_corr}\NormalTok{[}\DecValTok{2}\NormalTok{] L\_Omega\_k;}
  \DataTypeTok{vector}\NormalTok{\textless{}}\KeywordTok{lower}\NormalTok{=}\DecValTok{0}\NormalTok{\textgreater{}[}\DecValTok{2}\NormalTok{] tau\_j;}
  \DataTypeTok{vector}\NormalTok{\textless{}}\KeywordTok{lower}\NormalTok{=}\DecValTok{0}\NormalTok{\textgreater{}[}\DecValTok{2}\NormalTok{] tau\_k;}
\NormalTok{\}}

\CommentTok{// simple}
\KeywordTok{transformed parameters}\NormalTok{ \{}
  \CommentTok{// Calculate the effects per species, incorporating trait predictors}
  \DataTypeTok{matrix}\NormalTok{[}\DecValTok{2}\NormalTok{, K] beta\_hat = beta * xk\textquotesingle{} + diag\_pre\_multiply(tau\_k, L\_Omega\_k) * zk;}
  \CommentTok{// Mapping to segments}
  \DataTypeTok{matrix}\NormalTok{[}\DecValTok{2}\NormalTok{, J] A = beta\_hat * uj + diag\_pre\_multiply(tau\_j, L\_Omega\_j) * zj;}
\NormalTok{\}}

\KeywordTok{model}\NormalTok{ \{}
  \DataTypeTok{vector}\NormalTok{[N] mu;}
  \ControlFlowTok{for}\NormalTok{ (n }\ControlFlowTok{in} \DecValTok{1}\NormalTok{:N) \{}
\NormalTok{    mu[n] = x[n, ] * A[, jj[n]];}
\NormalTok{  \}}

\NormalTok{  to\_vector(zk) \textasciitilde{} std\_normal();}
\NormalTok{  to\_vector(zj) \textasciitilde{} std\_normal();}
\NormalTok{  tau\_k \textasciitilde{} normal(}\DecValTok{0}\NormalTok{, }\FloatTok{2.5}\NormalTok{);}
\NormalTok{  tau\_j \textasciitilde{} normal(}\DecValTok{0}\NormalTok{, }\FloatTok{2.5}\NormalTok{);}
\NormalTok{  L\_Omega\_k \textasciitilde{} lkj\_corr\_cholesky(}\DecValTok{2}\NormalTok{);}
\NormalTok{  L\_Omega\_j \textasciitilde{} lkj\_corr\_cholesky(}\DecValTok{2}\NormalTok{);}

\NormalTok{  to\_vector(beta) \textasciitilde{} normal(}\DecValTok{0}\NormalTok{, }\DecValTok{5}\NormalTok{);}
\NormalTok{  y \textasciitilde{} normal(mu, sigma);}
\NormalTok{\}}

\KeywordTok{generated quantities}\NormalTok{ \{}
  \DataTypeTok{vector}\NormalTok{[N] log\_lik;}
  \DataTypeTok{vector}\NormalTok{[N] mu;}
  \ControlFlowTok{for}\NormalTok{ (n }\ControlFlowTok{in} \DecValTok{1}\NormalTok{:N) \{}
\NormalTok{    mu[n] = x[n, ] * A[, jj[n]];}
\NormalTok{    log\_lik[n] = normal\_lpdf(y[n] | mu[n], sigma);}
\NormalTok{  \}}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\newpage

\section{Application of calibration: Estimating transpiration in a
plantation}\label{application-of-calibration-estimating-transpiration-in-a-plantation}

\subsection{Model for sapwood depth and
DBH}\label{model-for-sapwood-depth-and-dbh}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{data}\NormalTok{ \{}
  \DataTypeTok{int}\NormalTok{\textless{}}\KeywordTok{lower}\NormalTok{=}\DecValTok{0}\NormalTok{\textgreater{} N;}
  \DataTypeTok{vector}\NormalTok{[N] x;}
  \DataTypeTok{vector}\NormalTok{[N] y;}
\NormalTok{\}}

\KeywordTok{parameters}\NormalTok{ \{}
  \DataTypeTok{real}\NormalTok{ alpha;}
  \DataTypeTok{real}\NormalTok{ beta;}
  \DataTypeTok{real}\NormalTok{\textless{}}\KeywordTok{lower}\NormalTok{=}\DecValTok{0}\NormalTok{\textgreater{} sigma;}
\NormalTok{\}}

\KeywordTok{model}\NormalTok{ \{}
\NormalTok{  y \textasciitilde{} normal(alpha + beta * x, sigma);}
\NormalTok{  alpha \textasciitilde{} normal(}\DecValTok{0}\NormalTok{, }\FloatTok{2.5}\NormalTok{);}
\NormalTok{  beta \textasciitilde{} normal(}\DecValTok{0}\NormalTok{, }\FloatTok{2.5}\NormalTok{);}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\newpage

\subsection{Model for the effect of direction on sapwood depth on
K}\label{model-for-the-effect-of-direction-on-sapwood-depth-on-k}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{data}\NormalTok{ \{}
  \DataTypeTok{int}\NormalTok{\textless{}}\KeywordTok{lower}\NormalTok{=}\DecValTok{1}\NormalTok{\textgreater{} N;  }\CommentTok{// number of observations}
  \DataTypeTok{int}\NormalTok{\textless{}}\KeywordTok{lower}\NormalTok{=}\DecValTok{1}\NormalTok{\textgreater{} K; }\CommentTok{// number of predictors}
  \DataTypeTok{int}\NormalTok{\textless{}}\KeywordTok{lower}\NormalTok{=}\DecValTok{1}\NormalTok{\textgreater{} M;  }\CommentTok{// number of unique trees}
  \DataTypeTok{vector}\NormalTok{[N] log\_k;  }\CommentTok{// response variable log(k)}
  \DataTypeTok{vector}\NormalTok{[N] log\_k\_ref;  }\CommentTok{// offset}
  \DataTypeTok{matrix}\NormalTok{[N, K] x;  }\CommentTok{// predictor}
  \DataTypeTok{array}\NormalTok{[N] }\DataTypeTok{int}\NormalTok{\textless{}}\KeywordTok{lower}\NormalTok{=}\DecValTok{1}\NormalTok{, }\KeywordTok{upper}\NormalTok{=M\textgreater{} tree; }\CommentTok{// integer}
\NormalTok{\}}

\KeywordTok{parameters}\NormalTok{ \{}
  \DataTypeTok{vector}\NormalTok{[K] beta;}
  \DataTypeTok{real}\NormalTok{\textless{}}\KeywordTok{lower}\NormalTok{=}\DecValTok{0}\NormalTok{\textgreater{} sigma;  }\CommentTok{// error SD}
  \DataTypeTok{vector}\NormalTok{[M] phi\_raw;}
  \DataTypeTok{real}\NormalTok{\textless{}}\KeywordTok{lower}\NormalTok{=}\DecValTok{0}\NormalTok{\textgreater{} tau;}
\NormalTok{\}}

\KeywordTok{transformed parameters}\NormalTok{ \{}
  \DataTypeTok{vector}\NormalTok{[M] phi = phi\_raw * tau;  }\CommentTok{// tree random effects}
\NormalTok{\}}

\KeywordTok{model}\NormalTok{ \{}
\NormalTok{  beta \textasciitilde{} normal(}\DecValTok{0}\NormalTok{, }\FloatTok{2.5}\NormalTok{);}
\NormalTok{  tau \textasciitilde{} normal(}\DecValTok{0}\NormalTok{, }\FloatTok{2.5}\NormalTok{);}
\NormalTok{  phi\_raw \textasciitilde{} normal(}\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{);}
\NormalTok{  log\_k \textasciitilde{} normal(log\_k\_ref + x * beta + phi[tree], sigma);}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}




\end{document}
